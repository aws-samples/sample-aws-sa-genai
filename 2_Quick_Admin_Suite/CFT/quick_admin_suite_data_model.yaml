AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  CloudtrailLocation:
    Type: String
    MinLength: 1
    Description: 'Enter the location of your trail as specified in the Cloudtrail
      console, start with s3://, end with CloudTrail/. example: s3://cloudtrail-awslogs-123456789123-do-not-delete/AWSLogs/123456789123/CloudTrail/'
  StartDateParameter:
    Type: String
    MinLength: 10
    Description: Input the start date for the data in the Cloudtrail bucket in
      YYYY/MM/DD format. For example, if the earliest data in the bucket is from
      1st August 2021, use 2021/08/01
  CURSourceTable:
    Type: String
    Description: Provide CUR database and table name with format database.table_name
      as it exists in your account (e.g., billing.cur)
    AllowedPattern: ^[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+$
    ConstraintDescription: Must be in format database.table_name
    MinLength: 3
Resources:
  adminconsoledb2025:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: admin-console-2025
  groupmembership:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: group and user information which is generated by the etl_job_admin_suite_assets_access glue job
        Name: group_membership
        Parameters:
          has_encrypted_data: false
          classification: csv
          areColumnsQuoted: 'false'
          typeOfData: file
          columnsOrdered: 'true'
          delimiter: ','
        StorageDescriptor:
          Columns:
            - Comment: aws account_id
              Name: account_id
              Type: string
            - Comment: quicksight namespace
              Name: namespace
              Type: string
            - Comment: quicksight group
              Name: group
              Type: string
            - Comment: quicksight user
              Name: user
              Type: string
            - Comment: email of quicksight user
              Name: email
              Type: string
            - Comment: 'role of quicksight user: admin, author, reader'
              Name: role
              Type: string
            - Comment: 'identity_type of quicksight user: IAM, quicksight'
              Name: identity_type
              Type: string
            - Comment: 'arn of user'
              Name: user_arn
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/group_membership
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  objectaccess:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: objects and access information which is generated by the etl_job_admin_suite_assets_access glue job
        Name: object_access
        Parameters:
          has_encrypted_data: false
          classification: csv
          areColumnsQuoted: 'false'
          typeOfData: file
          columnsOrdered: 'true'
          delimiter: ','
        StorageDescriptor:
          Columns:
            - Comment: aws account_id
              Name: account_id
              Type: string
            - Comment: aws region name
              Name: aws_region
              Type: string
            - Comment: 'quicksight object type: dashboard, dataset and etc..'
              Name: object_type
              Type: string
            - Comment: quicksight object name
              Name: object_name
              Type: string
            - Comment: quicksight object id
              Name: object_id
              Type: string
            - Comment: quicksight principal type
              Name: principal_type
              Type: string
            - Comment: quicksight principal name
              Name: principal_name
              Type: string
            - Comment: quicksight principal arn
              Name: arn
              Type: string
            - Comment: quicksight namespace
              Name: namespace
              Type: string
            - Comment: 'access permissions of quicksight objects: who can do what on a
                dashboard'
              Name: permissions
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/object_access
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  folderassets:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: folder assets information which is generated by the etl_job_admin_suite_folder_assets job
        Name: folder_assets
        Parameters:
          has_encrypted_data: false
          classification: csv
          areColumnsQuoted: 'false'
          typeOfData: file
          columnsOrdered: 'true'
          delimiter: ','
        StorageDescriptor:
          Columns:
            - Comment: aws region name
              Name: aws_region
              Type: string
            - Comment: folder id
              Name: folder_id
              Type: string
            - Comment: member id
              Name: member_id
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/folder_assets
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  folderlk:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: folder permissions information which is generated by the etl_job_admin_suite_folder_assets job
        Name: folder_lk
        Parameters:
          has_encrypted_data: false
          classification: csv
          areColumnsQuoted: 'false'
          typeOfData: file
          columnsOrdered: 'true'
          delimiter: ','
        StorageDescriptor:
          Columns:
            - Comment: aws account_id
              Name: account_id
              Type: string
            - Comment: aws region name
              Name: aws_region
              Type: string
            - Comment: object type
              Name: object_type
              Type: string
            - Comment: folder name
              Name: folder_name
              Type: string
            - Comment: folder id
              Name: folder_id
              Type: string
            - Comment: folder arn
              Name: folder_arn
              Type: string
            - Comment: principal type
              Name: principal_type
              Type: string
            - Comment: principal name
              Name: principal_name
              Type: string
            - Comment: additional info
              Name: additional_info
              Type: string
            - Comment: actions
              Name: actions
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/folder_lk
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  folderpath:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: folder path information which is generated by the etl_job_admin_suite_folder_assets job
        Name: folder_path
        Parameters:
          has_encrypted_data: false
          classification: csv
          areColumnsQuoted: 'false'
          typeOfData: file
          columnsOrdered: 'true'
          delimiter: ','
        StorageDescriptor:
          Columns:
            - Comment: aws region name
              Name: aws_region
              Type: string
            - Comment: folder id
              Name: folder_id
              Type: string
            - Comment: folder name
              Name: folder_name
              Type: string
            - Comment: folder path
              Name: folder_path
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/folder_path
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  cloudtraillog:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: cloudtrail logs
        Name: cloudtrail_logs_pp
        StorageDescriptor:
          Columns:
            - Comment: eventversion
              Name: eventversion
              Type: string
            - Comment: useridentity
              Name: useridentity
              Type: struct<type:string,principalid:string,arn:string,accountid:string,invokedby:string,accesskeyid:string,username:string,sessioncontext:struct<attributes:struct<mfaauthenticated:string,creationdate:string>,sessionissuer:struct<type:string,principalid:string,arn:string,accountid:string,username:string>>>
            - Comment: eventtime
              Name: eventtime
              Type: string
            - Comment: eventsource
              Name: eventsource
              Type: string
            - Comment: eventname
              Name: eventname
              Type: string
            - Comment: awsregion
              Name: awsregion
              Type: string
            - Comment: sourceipaddress
              Name: sourceipaddress
              Type: string
            - Comment: useragent
              Name: useragent
              Type: string
            - Comment: errorcode
              Name: errorcode
              Type: string
            - Comment: errormessage
              Name: errormessage
              Type: string
            - Comment: requestparameters
              Name: requestparameters
              Type: string
            - Comment: responseelements
              Name: responseelements
              Type: string
            - Comment: additionaleventdata
              Name: additionaleventdata
              Type: string
            - Comment: requestid
              Name: requestid
              Type: string
            - Comment: eventid
              Name: eventid
              Type: string
            - Comment: resources
              Name: resources
              Type: array<struct<arn:string,accountid:string,type:string>>
            - Comment: eventtype
              Name: eventtype
              Type: string
            - Comment: apiversion
              Name: apiversion
              Type: string
            - Comment: readonly
              Name: readonly
              Type: string
            - Comment: recipientaccountid
              Name: recipientaccountid
              Type: string
            - Comment: serviceeventdetails
              Name: serviceeventdetails
              Type: string
            - Comment: sharedeventid
              Name: sharedeventid
              Type: string
            - Comment: vpcendpointid
              Name: vpcendpointid
              Type: string
          InputFormat: com.amazon.emr.cloudtrail.CloudTrailInputFormat
          Location: !Ref CloudtrailLocation
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: com.amazon.emr.hive.serde.CloudTrailSerde
          StoredAsSubDirectories: false
        PartitionKeys:
          - Name: region
            Comment: aws_region
            Type: string
          - Name: timestamp
            Comment: timestamp
            Type: string
        Parameters:
          classification: cloudtrail
          projection.enabled: true
          projection.region.type: enum
          projection.region.values: 'us-east-1,us-east-2,us-west-1,us-west-2,eu-west-1,eu-central-1,ap-southeast-1,ap-southeast-2,ap-northeast-1,ap-northeast-2,sa-east-1'
          projection.timestamp.type: date
          projection.timestamp.format: yyyy/MM/dd
          projection.timestamp.range: !Join
            - ','
            - - !Ref StartDateParameter
              - NOW
          projection.timestamp.interval: '1'
          projection.timestamp.interval.unit: DAYS
          storage.location.template: !Join
            - ''
            - - !Ref CloudtrailLocation
              - /${region}
              - /${timestamp}
        TableType: EXTERNAL_TABLE
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: cloudtrail logs
        Name: cloudtrail_logs_pp
        StorageDescriptor:
          Columns:
            - Comment: eventversion
              Name: eventversion
              Type: string
            - Comment: useridentity
              Name: useridentity
              Type: struct<type:string,principalid:string,arn:string,accountid:string,invokedby:string,accesskeyid:string,username:string,sessioncontext:struct<attributes:struct<mfaauthenticated:string,creationdate:string>,sessionissuer:struct<type:string,principalid:string,arn:string,accountid:string,username:string>>>
            - Comment: eventtime
              Name: eventtime
              Type: string
            - Comment: eventsource
              Name: eventsource
              Type: string
            - Comment: eventname
              Name: eventname
              Type: string
            - Comment: awsregion
              Name: awsregion
              Type: string
            - Comment: sourceipaddress
              Name: sourceipaddress
              Type: string
            - Comment: useragent
              Name: useragent
              Type: string
            - Comment: errorcode
              Name: errorcode
              Type: string
            - Comment: errormessage
              Name: errormessage
              Type: string
            - Comment: requestparameters
              Name: requestparameters
              Type: string
            - Comment: responseelements
              Name: responseelements
              Type: string
            - Comment: additionaleventdata
              Name: additionaleventdata
              Type: string
            - Comment: requestid
              Name: requestid
              Type: string
            - Comment: eventid
              Name: eventid
              Type: string
            - Comment: resources
              Name: resources
              Type: array<struct<arn:string,accountid:string,type:string>>
            - Comment: eventtype
              Name: eventtype
              Type: string
            - Comment: apiversion
              Name: apiversion
              Type: string
            - Comment: readonly
              Name: readonly
              Type: string
            - Comment: recipientaccountid
              Name: recipientaccountid
              Type: string
            - Comment: serviceeventdetails
              Name: serviceeventdetails
              Type: string
            - Comment: sharedeventid
              Name: sharedeventid
              Type: string
            - Comment: vpcendpointid
              Name: vpcendpointid
              Type: string
          InputFormat: com.amazon.emr.cloudtrail.CloudTrailInputFormat
          Location: !Join
            - ''
            - - !Ref CloudtrailLocation
              - !Ref AWS::Region
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: com.amazon.emr.hive.serde.CloudTrailSerde
          StoredAsSubDirectories: false
        PartitionKeys:
          - Name: timestamp
            Comment: timestamp
            Type: string
        Parameters:
          classification: cloudtrail
          projection.enabled: true
          projection.timestamp.type: date
          projection.timestamp.format: yyyy/MM/dd
          projection.timestamp.range: !Join
            - ','
            - - !Ref StartDateParameter
              - NOW
          projection.timestamp.interval: '1'
          projection.timestamp.interval.unit: DAYS
          storage.location.template: !Join
            - ''
            - - !Ref CloudtrailLocation
              - !Ref AWS::Region
              - /${timestamp}
        TableType: EXTERNAL_TABLE
  datadict:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: data dictionry
        Name: data_dict
        Parameters:
          classification: csv
        StorageDescriptor:
          Columns:
            - Comment: datasetname
              Name: datasetname
              Type: string
            - Comment: datasetid
              Name: datasetid
              Type: string
            - Comment: columnname
              Name: columnname
              Type: string
            - Comment: columntype
              Name: columntype
              Type: string
            - Comment: columndesc
              Name: columndesc
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/data_dictionary
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  datasetsinfo:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: datasets info
        Name: datasets_info
        Parameters:
          classification: csv
        StorageDescriptor:
          Columns:
            - Comment: aws_region
              Name: aws_region
              Type: string
            - Comment: dashboard_name
              Name: dashboard_name
              Type: string
            - Comment: dashboardid
              Name: dashboardid
              Type: string
            - Comment: analysis
              Name: analysis
              Type: string
            - Comment: analysis_id
              Name: analysis_id
              Type: string
            - Comment: dataset_name
              Name: dataset_name
              Type: string
            - Comment: dataset_id
              Name: dataset_id
              Type: string
            - Comment: lastupdatedtime
              Name: lastupdatedtime
              Type: string
            - Comment: data_source_name
              Name: data_source_name
              Type: string
            - Comment: data_source_id
              Name: data_source_id
              Type: string
            - Comment: catalog
              Name: catalog
              Type: string
            - Comment: sqlname/schema
              Name: sqlname/schema
              Type: string
            - Comment: sqlquery/table_name
              Name: sqlquery/table_name
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/datsets_info
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: '|'
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  qtopicinfo:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: q topics info
        Name: q_topic_info
        Parameters:
          classification: csv
          skip.header.line.count: 1
        StorageDescriptor:
          Columns:
            - Comment: topic_id
              Name: topic_id
              Type: string
            - Comment: topic_name
              Name: topic_name
              Type: string
            - Comment: dataset_arn
              Name: dataset_arn
              Type: string
            - Comment: dataset_name
              Name: dataset_name
              Type: string
            - Comment: description
              Name: description
              Type: string
            - Comment: user_experience_version
              Name: user_experience_version
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/q_topics_info
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  qobjectaccessinfo:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Description: q object access
        Name: q_object_access
        Parameters:
          classification: csv
          skip.header.line.count: 1
        StorageDescriptor:
          Columns:
            - Comment: aws account_id
              Name: account_id
              Type: string
            - Comment: aws region name
              Name: aws_region
              Type: string
            - Comment: 'quicksight object type: dashboard, dataset and etc..'
              Name: object_type
              Type: string
            - Comment: quicksight object name
              Name: object_name
              Type: string
            - Comment: quicksight object id
              Name: object_id
              Type: string
            - Comment: quicksight principal type
              Name: principal_type
              Type: string
            - Comment: quicksight principal name
              Name: principal_name
              Type: string
            - Comment: quicksight principal arn
              Name: arn
              Type: string
            - Comment: quicksight namespace
              Name: namespace
              Type: string
            - Comment: 'access permissions of quicksight objects: who can do what on a
                Q topic'
              Name: permissions
              Type: string	  
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://admin-console-new-
              - !Ref AWS::AccountId
              - /monitoring/quicksight/q_object_access
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              field.delim: ','
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  QuickSightCrudEventsView:
    Type: 'AWS::Athena::NamedQuery'
    Properties:
      Database: admin-console-2025
      Description: 'View for QuickSight CRUD events from CloudTrail logs'
      Name: quicksight_crud_events_view
      QueryString: |
        CREATE OR REPLACE VIEW quicksight_crud_events AS 
        SELECT *
        FROM cloudtrail_logs_pp
        WHERE (
          eventsource = 'quicksight.amazonaws.com'
          AND parse_datetime(eventtime, 'yyyy-MM-dd''T''HH:mm:ss''Z') >= (current_timestamp - INTERVAL '40' DAY)
          AND REGEXP_LIKE(eventname, '^(Create|Update|Delete)')
        )
      WorkGroup: primary
  QuickSightQueryDbEventsView:
    Type: 'AWS::Athena::NamedQuery'
    Properties:
      Database: admin-console-2025
      Description: 'View for QuickSight QueryDatabase events from CloudTrail logs'
      Name: quicksight_querydb_events_view
      QueryString: |
        CREATE OR REPLACE VIEW quicksight_querydb_events AS 
        SELECT
          *
        , JSON_EXTRACT_SCALAR(serviceeventdetails, '$.eventRequestDetails.dataSourceId') datasourceid
        , JSON_EXTRACT_SCALAR(serviceeventdetails, '$.eventRequestDetails.queryId') queryid
        , JSON_EXTRACT_SCALAR(serviceeventdetails, '$.eventRequestDetails.resourceId') dashboard_analysis
        , JSON_EXTRACT_SCALAR(serviceeventdetails, '$.eventRequestDetails.dataSetId') datasetid
        , JSON_EXTRACT_SCALAR(serviceeventdetails, '$.eventRequestDetails.dataSetMode') datasetmode
        FROM cloudtrail_logs_pp
        WHERE ((eventsource = 'quicksight.amazonaws.com') AND (parse_datetime(eventtime, 'yyyy-MM-dd''T''HH:mm:ss''Z') >= (current_timestamp - INTERVAL '40' DAY)) AND (eventname = 'QueryDatabase'))
      WorkGroup: primary
  QsUsageCurView:
    Type: 'AWS::Athena::NamedQuery'
    Properties:
      Database: admin-console-2025
      Description: 'QuickSight usage and cost analysis view from CUR data'
      Name: qs_usage_cur_vw
      QueryString: |
        CREATE OR REPLACE VIEW "qs_usage_cur_vw" AS 
        SELECT
          bill_payer_account_id
        , line_item_usage_account_id
        , concat(DATE_FORMAT(line_item_usage_start_date, '%Y-%m'), '-01') month_line_item_usage_start_date
        , line_item_usage_type
        , (CASE WHEN (LOWER(line_item_usage_type) LIKE 'qs-user-enterprise%') THEN 'Users - Enterprise' WHEN (LOWER(line_item_usage_type) LIKE 'qs-user-standard%') THEN 'Users - Standard' WHEN (LOWER(line_item_usage_type) LIKE 'qs-reader%') THEN 'Reader Usage' WHEN (LOWER(line_item_usage_type) LIKE '%spice') THEN 'SPICE' WHEN (LOWER(line_item_usage_type) LIKE '%alerts%') THEN 'Alerts' WHEN (LOWER(line_item_usage_type) LIKE '%-q%') THEN 'QuickSight Q' WHEN (LOWER(line_item_usage_type) LIKE '%-report%') THEN 'Paginated Reporting' WHEN (LOWER(line_item_usage_type) LIKE '%-reader-pro%') THEN 'Reader PRO' WHEN (LOWER(line_item_usage_type) LIKE '%-author-pro%') THEN 'Author PRO' WHEN (LOWER(line_item_usage_type) LIKE '%-reader-enterprise%') THEN 'Reader Usage' ELSE line_item_usage_type END) qs_usage_type
        , line_item_line_item_description
        , line_item_line_item_type
        , product['group'] product_group
        , pricing_unit
        , line_item_resource_id
        , product_usagetype
        , line_item_unblended_rate
        , line_item_blended_rate
        , line_item_operation
        , SUM(CAST(line_item_usage_amount AS DOUBLE)) sum_line_item_usage_amount
        , SUM(CAST(line_item_unblended_cost AS DECIMAL(16, 8))) sum_line_item_unblended_cost
        , SUM(CAST(line_item_blended_cost AS DECIMAL(16, 8))) line_item_blended_cost
        FROM ${CURSourceTable}
        WHERE ((product['product_name'] = 'Amazon QuickSight') AND (line_item_line_item_type IN ('DiscountedUsage', 'Usage')))
        GROUP BY bill_payer_account_id, line_item_usage_account_id, DATE_FORMAT(line_item_usage_start_date, '%Y-%m'), 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14
        ORDER BY month_line_item_usage_start_date ASC, sum_line_item_unblended_cost DESC, month_line_item_usage_start_date ASC, sum_line_item_unblended_cost DESC
      WorkGroup: primary
  CwQsDsPivotView:
    Type: 'AWS::Athena::NamedQuery'
    Properties:
      Database: admin-console-2025
      Description: 'Pivot view for CloudWatch QuickSight dataset metrics'
      Name: cw_qs_ds_pivot_view
      QueryString: !Sub |
        CREATE OR REPLACE VIEW cw_qs_ds_pivot AS 
        SELECT
          timestamp
        , account_id
        , region
        , dimensions.datasetid datasetid
        , CAST(MAX((CASE WHEN (metric_name = 'IngestionErrorCount') THEN value.sum END)) AS INTEGER) IngestionErrorCount
        , MAX((CASE WHEN (metric_name = 'IngestionErrorCount') THEN unit END)) IngestionErrorCount_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'IngestionInvocationCount') THEN value.sum END)) AS INTEGER) IngestionInvocationCount
        , MAX((CASE WHEN (metric_name = 'IngestionInvocationCount') THEN unit END)) IngestionInvocationCount_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'IngestionLatency') THEN value.sum END)) AS DOUBLE) IngestionLatency
        , MAX((CASE WHEN (metric_name = 'IngestionLatency') THEN unit END)) IngestionLatency_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'IngestionRowCount') THEN value.sum END)) AS INTEGER) IngestionRowCount
        , MAX((CASE WHEN (metric_name = 'IngestionRowCount') THEN unit END)) IngestionRowCount_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'SPICECapacityLimitInMB') THEN value.sum END)) AS DOUBLE) SPICECapacityLimitInMB
        , MAX((CASE WHEN (metric_name = 'SPICECapacityLimitInMB') THEN unit END)) SPICECapacityLimitInMB_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'SPICECapacityConsumedInMB') THEN value.sum END)) AS DOUBLE) SPICECapacityConsumedInMB
        , MAX((CASE WHEN (metric_name = 'SPICECapacityConsumedInMB') THEN unit END)) SPICECapacityConsumedInMB_Unit
        FROM cw_qs_ds_${AWS::AccountId}
        GROUP BY timestamp, account_id, region, dimensions
        ORDER BY timestamp ASC, account_id ASC, region ASC
      WorkGroup: primary
  CwQsDashVisualPivotView:
    Type: 'AWS::Athena::NamedQuery'
    Properties:
      Database: admin-console-2025
      Description: 'Pivot view for CloudWatch QuickSight dashboard visual metrics'
      Name: cw_qs_dash_visual_pivot_view
      QueryString: !Sub |
        CREATE OR REPLACE VIEW cw_qs_dash_visual_pivot AS 
        SELECT
          timestamp
        , account_id
        , region
        , dimensions.dashboardid dashboardid
        , dimensions.sheetid sheetid
        , dimensions.visualid visualid
        , CAST(MAX((CASE WHEN (metric_name = 'DashboardViewCount') THEN value.sum END)) AS INTEGER) DashboardViewCount
        , MAX((CASE WHEN (metric_name = 'DashboardViewCount') THEN unit END)) DashboardViewCount_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'DashboardViewLoadTime') THEN value.sum END)) AS DOUBLE) DashboardViewLoadTime
        , MAX((CASE WHEN (metric_name = 'DashboardViewLoadTime') THEN unit END)) DashboardViewLoadTime_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'VisualLoadTime') THEN value.sum END)) AS DOUBLE) VisualLoadTime
        , MAX((CASE WHEN (metric_name = 'VisualLoadTime') THEN unit END)) VisualLoadTime_Unit
        , CAST(MAX((CASE WHEN (metric_name = 'VisualLoadErrorCount') THEN value.sum END)) AS INTEGER) VisualLoadErrorCount
        , MAX((CASE WHEN (metric_name = 'VisualLoadErrorCount') THEN unit END)) VisualLoadErrorCount_Unit
        FROM cw_qs_dash_visual_${AWS::AccountId}
        GROUP BY timestamp, account_id, region, dimensions
        ORDER BY timestamp ASC, account_id ASC, region ASC
      WorkGroup: primary
  CwQsDsTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Name: !Sub cw_qs_ds_${AWS::AccountId}
        Description: CloudWatch Metrics Stream data for QuickSight
        Parameters:
          classification: json
          partition_filtering.enabled: 'true'
        StorageDescriptor:
          Columns:
            - Name: metric_stream_name
              Type: string
              Comment: from deserializer
            - Name: account_id
              Type: string
              Comment: from deserializer
            - Name: region
              Type: string
              Comment: from deserializer
            - Name: namespace
              Type: string
              Comment: from deserializer
            - Name: metric_name
              Type: string
              Comment: from deserializer
            - Name: dimensions
              Type: struct<DatasetId:string>
              Comment: from deserializer
            - Name: timestamp
              Type: bigint
              Comment: from deserializer
            - Name: value
              Type: struct<max:double,min:double,sum:double,count:double>
              Comment: from deserializer
            - Name: unit
              Type: string
              Comment: from deserializer
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
            Parameters:
              paths: account_id,dimensions,metric_name,metric_stream_name,namespace,region,timestamp,unit,value
          Location: !Sub s3://cw-qs-ds-${AWS::AccountId}/
        PartitionKeys:
          - Name: partition_0
            Type: string
          - Name: partition_1
            Type: string
          - Name: partition_2
            Type: string
          - Name: partition_3
            Type: string
        TableType: EXTERNAL_TABLE
  CwQsDashVisualTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref adminconsoledb2025
      TableInput:
        Name: !Sub cw_qs_dash_visual_${AWS::AccountId}
        Description: CloudWatch Metrics Stream data for QuickSight Dashboard Visual
        Parameters:
          classification: json
          partition_filtering.enabled: 'true'
        StorageDescriptor:
          Columns:
            - Name: metric_stream_name
              Type: string
              Comment: from deserializer
            - Name: account_id
              Type: string
              Comment: from deserializer
            - Name: region
              Type: string
              Comment: from deserializer
            - Name: namespace
              Type: string
              Comment: from deserializer
            - Name: metric_name
              Type: string
              Comment: from deserializer
            - Name: dimensions
              Type: struct<DashboardId:string,SheetId:string,VisualId:string>
              Comment: from deserializer
            - Name: timestamp
              Type: bigint
              Comment: from deserializer
            - Name: value
              Type: struct<max:double,min:double,sum:double,count:double>
              Comment: from deserializer
            - Name: unit
              Type: string
              Comment: from deserializer
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
            Parameters:
              paths: account_id,dimensions,metric_name,metric_stream_name,namespace,region,timestamp,unit,value
          Location: !Sub s3://cw-qs-dash-visual-${AWS::AccountId}/
        PartitionKeys:
          - Name: partition_0
            Type: string
          - Name: partition_1
            Type: string
          - Name: partition_2
            Type: string
          - Name: partition_3
            Type: string
        TableType: EXTERNAL_TABLE
  CrawlerCwQsDs:
    Type: AWS::Glue::Crawler
    Properties:
      Name: crawler-cw-qs-ds
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/QuickSightAdminConsole2025
      DatabaseName: admin-console-2025
      Targets:
        S3Targets:
          - Path: !Sub s3://cw-qs-ds-${AWS::AccountId}/
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: DEPRECATE_IN_DATABASE
      Configuration: |
        {
          "Version": 1.0,
          "CrawlerOutput": {
            "Partitions": {"AddOrUpdateBehavior": "InheritFromTable"},
            "Tables": {"AddOrUpdateBehavior": "MergeNewColumns"}
          },
          "Grouping": {
            "TableGroupingPolicy": "CombineCompatibleSchemas"
          },
          "CreatePartitionIndex": true
        }
      RecrawlPolicy:
        RecrawlBehavior: CRAWL_EVERYTHING
  CrawlerCwQsDashVisual:
    Type: AWS::Glue::Crawler
    Properties:
      Name: crawler-cw-qs-dash-visual
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/QuickSightAdminConsole2025
      DatabaseName: admin-console-2025
      Targets:
        S3Targets:
          - Path: !Sub s3://cw-qs-dash-visual-${AWS::AccountId}/
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: DEPRECATE_IN_DATABASE
      Configuration: |
        {
          "Version": 1.0,
          "CrawlerOutput": {
            "Partitions": {"AddOrUpdateBehavior": "InheritFromTable"},
            "Tables": {"AddOrUpdateBehavior": "MergeNewColumns"}
          },
          "Grouping": {
            "TableGroupingPolicy": "CombineCompatibleSchemas"
          },
          "CreatePartitionIndex": true
        }
      RecrawlPolicy:
        RecrawlBehavior: CRAWL_EVERYTHING
  CrawlerCwQsDsAddPart:
    Type: AWS::Glue::Crawler
    DependsOn: CwQsDsTable
    Properties:
      Name: crawler-cw-qs-ds-add-part
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/QuickSightAdminConsole2025
      DatabaseName: admin-console-2025
      Targets:
        CatalogTargets:
          - DatabaseName: admin-console-2025
            Tables:
              - !Sub cw_qs_ds_${AWS::AccountId}
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG
      Schedule:
        ScheduleExpression: cron(0 * * * ? *)
      Configuration: |
        {
          "Version": 1.0,
          "CrawlerOutput": {
            "Partitions": {"AddOrUpdateBehavior": "InheritFromTable"},
            "Tables": {"AddOrUpdateBehavior": "MergeNewColumns"}
          }
        }
  CrawlerCwQsDashVisualAddPart:
    Type: AWS::Glue::Crawler
    DependsOn: CwQsDashVisualTable
    Properties:
      Name: crawler-cw-qs-dash-visual-add-part
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/QuickSightAdminConsole2025
      DatabaseName: admin-console-2025
      Targets:
        CatalogTargets:
          - DatabaseName: admin-console-2025
            Tables:
              - !Sub cw_qs_dash_visual_${AWS::AccountId}
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG
      Schedule:
        ScheduleExpression: cron(0 * * * ? *)
      Configuration: |
        {
          "Version": 1.0,
          "CrawlerOutput": {
            "Partitions": {"AddOrUpdateBehavior": "InheritFromTable"},
            "Tables": {"AddOrUpdateBehavior": "MergeNewColumns"}
          }
        }